generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model PrivateEquityFirm {
  id                    String   @id @default(cuid())
  name                  String   @unique
  slug                  String   @unique
  description           String?  @db.Text
  website               String?
  logoUrl               String?
  headquarters          String?
  foundedYear           Int?
  assetsUnderManagement String?  // e.g., "$5B+"

  platforms      Platform[]
  brands         Brand[]
  acquisitions   Acquisition[]
  articles       Article[]
  watchlistItems WatchlistItem[]
  pipelineItems  PipelineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

// Platform = PE-backed consolidator (Apex, Wrench, Sila, etc.)
// Sits between PrivateEquityFirm and Brand
model Platform {
  id                    String   @id @default(cuid())
  name                  String
  slug                  String   @unique
  description           String?  @db.Text
  website               String?
  logoUrl               String?
  brandsPageUrl         String?  // URL to their portfolio/brands page
  headquarters          String?
  foundedYear           Int?
  estimatedPortfolioSize String? // e.g., "100-200", "50+"
  employeeCount         Int?
  valuationMillions     Decimal? @db.Decimal(12, 2)
  isActive              Boolean  @default(true)
  notes                 String?  @db.Text
  lastScrapedAt         DateTime?
  lastBrandSnapshot     Json?    // Stores brand list for diff detection

  privateEquityFirm   PrivateEquityFirm? @relation(fields: [privateEquityFirmId], references: [id])
  privateEquityFirmId String?

  brands         Brand[]
  acquisitions   Acquisition[]
  articles       Article[]
  scrapeSources  ScrapeSource[]
  watchlistItems WatchlistItem[]
  pipelineItems  PipelineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([privateEquityFirmId])
}

model Brand {
  id               String    @id @default(cuid())
  name             String
  slug             String    @unique
  website          String?
  logoUrl          String?
  description      String?   @db.Text
  location         String?   // City, State (legacy)
  city             String?
  state            String?
  phone            String?
  email            String?
  services         String[]  // Array: ['HVAC', 'Plumbing', 'Electrical']
  serviceArea      String?   // e.g., "Southeast US"
  foundedYear      Int?
  employeeCount    Int?
  acquisitionDate  DateTime?
  acquisitionPrice String?   // e.g., "$15M" or "Undisclosed"
  isVerified       Boolean   @default(false)
  verificationDate DateTime?
  verificationSource String?

  privateEquityFirm   PrivateEquityFirm? @relation(fields: [privateEquityFirmId], references: [id])
  privateEquityFirmId String?

  platform   Platform? @relation(fields: [platformId], references: [id])
  platformId String?

  acquisitions   Acquisition[]
  articles       Article[]
  watchlistItems WatchlistItem[]
  pipelineItems  PipelineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([privateEquityFirmId])
  @@index([platformId])
  @@index([state])
}

model Acquisition {
  id          String   @id @default(cuid())
  date        DateTime
  amount      String?  // e.g., "$15M" or "Undisclosed"
  dealType    String   @default("acquisition") // acquisition, merger, investment
  sourceUrl   String?
  sourceTitle String?
  notes       String?  @db.Text

  privateEquityFirm   PrivateEquityFirm @relation(fields: [privateEquityFirmId], references: [id])
  privateEquityFirmId String

  platform   Platform? @relation(fields: [platformId], references: [id])
  platformId String?

  brand   Brand?  @relation(fields: [brandId], references: [id])
  brandId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([privateEquityFirmId])
  @@index([platformId])
  @@index([brandId])
  @@index([date(sort: Desc)])
}

model Article {
  id            String    @id @default(cuid())
  title         String
  url           String    @unique
  source        String    // e.g., "ACHR News", "Business Wire"
  publishedDate DateTime?
  summary       String?   @db.Text
  imageUrl      String?
  articleType   String?   // 'acquisition', 'expansion', 'leadership', 'industry'
  isProcessed   Boolean   @default(false)
  processedAt   DateTime?

  privateEquityFirm   PrivateEquityFirm? @relation(fields: [privateEquityFirmId], references: [id])
  privateEquityFirmId String?

  platform   Platform? @relation(fields: [platformId], references: [id])
  platformId String?

  brand   Brand?  @relation(fields: [brandId], references: [id])
  brandId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([privateEquityFirmId])
  @@index([platformId])
  @@index([brandId])
  @@index([publishedDate(sort: Desc)])
  @@index([articleType])
}

model ScrapeSource {
  id                   String   @id @default(cuid())
  name                 String
  url                  String
  sourceType           String?  // 'platform_brands_page', 'news_feed', 'press_release'
  scrapeFrequencyHours Int      @default(24)
  selectorConfig       Json?    // CSS selectors, XPath, etc.
  isActive             Boolean  @default(true)
  lastScrapedAt        DateTime?
  lastSuccessAt        DateTime?
  consecutiveFailures  Int      @default(0)

  platform   Platform? @relation(fields: [platformId], references: [id])
  platformId String?

  scrapeLogs ScrapeLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([platformId])
  @@index([sourceType])
}

model ScrapeLog {
  id             String    @id @default(cuid())
  startedAt      DateTime
  completedAt    DateTime?
  status         String?   // 'success', 'partial', 'failed'
  recordsFound   Int?
  recordsNew     Int?
  recordsUpdated Int?
  errorMessage   String?   @db.Text

  source   ScrapeSource @relation(fields: [sourceId], references: [id])
  sourceId String

  createdAt DateTime @default(now())

  @@index([sourceId])
  @@index([startedAt(sort: Desc)])
}

// User authentication
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  passwordHash     String
  name             String?
  role             String    @default("user") // 'user', 'admin'
  subscriptionTier String    @default("free") // 'free', 'basic', 'pro'
  stripeCustomerId String?   @unique
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  sessions         Session[]
  watchlistItems   WatchlistItem[]
  pipelines        Pipeline[]
  pipelineItems    PipelineItem[]

  @@index([email])
  @@index([subscriptionTier])
  @@index([role])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// Watchlist - tracks what entities a user is watching
model WatchlistItem {
  id                  String   @id @default(cuid())
  userId              String
  privateEquityFirmId String?
  platformId          String?
  brandId             String?
  notes               String?  @db.Text
  emailOnNewArticle   Boolean  @default(true)
  emailOnAcquisition  Boolean  @default(true)
  addedAt             DateTime @default(now())

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  privateEquityFirm PrivateEquityFirm? @relation(fields: [privateEquityFirmId], references: [id], onDelete: Cascade)
  platform          Platform?          @relation(fields: [platformId], references: [id], onDelete: Cascade)
  brand             Brand?             @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, privateEquityFirmId])
  @@unique([userId, platformId])
  @@unique([userId, brandId])
  @@index([userId])
}

// Pipeline - custom user-created lists
model Pipeline {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?  @db.Text
  color       String?
  position    Int      @default(0)

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items PipelineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// PipelineItem - entities within a pipeline
model PipelineItem {
  id                  String   @id @default(cuid())
  pipelineId          String
  userId              String
  privateEquityFirmId String?
  platformId          String?
  brandId             String?
  status              String   @default("watching")
  priority            String?
  notes               String?  @db.Text
  position            Int      @default(0)
  statusChangedAt     DateTime @default(now())
  addedAt             DateTime @default(now())

  pipeline          Pipeline           @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  privateEquityFirm PrivateEquityFirm? @relation(fields: [privateEquityFirmId], references: [id], onDelete: Cascade)
  platform          Platform?          @relation(fields: [platformId], references: [id], onDelete: Cascade)
  brand             Brand?             @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pipelineId, privateEquityFirmId])
  @@unique([pipelineId, platformId])
  @@unique([pipelineId, brandId])
  @@index([pipelineId])
  @@index([userId])
  @@index([status])
}
